{
  "kind": "build_request",
  "title": "Fix customer chat history visibility, enable customer replies, and remove payment gate from ticket creation",
  "projectName": "PKG Tech Support",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-17",
      "text": "Fix the ChatSection component so that customers can see the full chat message history for their active support sessions. Ensure that when a customer selects a ticket or opens a chat session, all previously exchanged messages are fetched from the backend and displayed in chronological order in the chat UI. Debug and resolve any query filtering, principal mismatch, or data-fetching issues that prevent message history from rendering on the customer side.",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "unable to see chat history on custome rcre"
        ]
      },
      "acceptanceCriteria": [
        "When a customer opens a chat session tied to a ticket, all previous messages (both customer and technician messages) are visible in the chat window.",
        "Messages are displayed in chronological order with correct sender attribution.",
        "The chat history persists across page refreshes for the customer.",
        "No console errors related to message fetching or principal filtering appear on the customer side."
      ]
    },
    {
      "id": "REQ-18",
      "text": "Fix the ChatSection component so that customers can type and send reply messages in an active chat session. Ensure the message input field and send button are rendered and functional for customers (not just technicians). Debug and resolve any role-check, actor call, or state management issues that block customers from submitting new messages. After sending, the new message must appear immediately in the chat thread.",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "cust cant reply"
        ]
      },
      "acceptanceCriteria": [
        "The chat message input field is visible and editable for authenticated customers.",
        "The send button is enabled and submits the customer's message to the backend successfully.",
        "After sending, the new message appears in the chat thread without requiring a manual refresh.",
        "Customers cannot send messages to sessions that do not belong to them.",
        "No permission errors or silent failures occur when a customer submits a message."
      ]
    },
    {
      "id": "REQ-19",
      "text": "Remove all payment gate checks from the ticket creation flow in ClientPortal and TicketCreationForm. Customers must be able to open the ticket creation dialog and submit a new support ticket without any payment plan validation, Stripe/Razorpay checks, or subscription status checks blocking the action. The 'Create Ticket' button and dialog must be unconditionally accessible to any authenticated customer.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "allow to create the tickets for the now without payment intrigade"
        ]
      },
      "acceptanceCriteria": [
        "The 'Create Ticket' button in ClientPortal is visible and clickable for all authenticated customers regardless of payment/plan status.",
        "No payment prompt, paywall dialog, or plan-upgrade message appears before or during ticket creation.",
        "Submitting the ticket creation form successfully creates a ticket in the backend and shows it in the customer's ticket list.",
        "Removing the payment gate does not break any other payment-related features (PaymentSection, service plans)."
      ]
    },
    {
      "id": "REQ-20",
      "text": "Audit the backend `main.mo` actor for any authorization checks on `getChatMessages`, `sendMessage`, or equivalent chat query/update functions that incorrectly restrict customer principals from reading or writing their own chat messages. Ensure that customers can call these functions for sessions linked to their own tickets, while preventing access to other customers' sessions. Fix any overly restrictive or missing principal-based access control that causes the chat history and reply issues.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "use automation for fixing the errors"
        ]
      },
      "acceptanceCriteria": [
        "The `getChatMessages` (or equivalent) backend function returns messages to the authenticated customer caller for their own ticket sessions.",
        "The `sendMessage` (or equivalent) backend function accepts calls from authenticated customer principals for their own sessions.",
        "Access to another customer's chat session is denied with an appropriate error.",
        "Technician/expert access to all sessions remains unaffected."
      ]
    }
  ],
  "constraints": [
    "Do not modify files under frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useActor.ts, frontend/src/main.tsx, or frontend/src/components/ui.",
    "Do not remove or break the PaymentSection component or any existing payment/plan UI â€” only remove payment gate checks that block ticket creation.",
    "All backend logic must remain in the single actor file backend/main.mo."
  ],
  "nonGoals": [
    "Integrating a new payment provider or modifying existing Stripe/Razorpay checkout flows.",
    "Redesigning the chat UI layout or adding new chat features beyond fixing history visibility and reply functionality.",
    "Changes to the ExpertDashboard chat or technician-side chat behaviour.",
    "Adding real-time WebSocket or push notification support."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}